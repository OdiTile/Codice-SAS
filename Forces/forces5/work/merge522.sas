/* merge522.sas + F4 G3 H4 I1D ----- I1H_alt3_T2              */
*--- Accept or Deny a Job?  --------------   01-02-06 ------------------;
* LIBNAME LIB '\\Kaos\Lan\Users\Mario\forces5\work\sas';  
* LIBNAME LIBRARY '\\Kaos\Lan\Users\Mario\forces5\work\sas';  
* FILENAME QBase '\\Kaos\Lan\Users\Mario\forces5\source\RBase.mdb';  

 LIBNAME LIB 'C:\Documents and Settings\barney\dati\lav\forces5\work\sas'; 
 LIBNAME LIBRARY 'C:\Documents and Settings\barney\dati\lav\forces5\work\sas'; 
 FILENAME QBase 'C:\Documents and Settings\barney\dati\lav\forces5\source\RBase.mdb'; 

* LIBNAME LIB 'C:\Documents and Settings\herman\dati\lav\forces5\work\sas'; 
* LIBNAME LIBRARY 'C:\Documents and Settings\herman\dati\lav\forces5\work\sas'; 
* FILENAME QBase 'C:\Documents and Settings\herman\dati\lav\forces5\source\RBase.mdb'; 


options nocenter;
/* modifica compioneforces per il merge */
/* 22-11-04 - - - non serve piu'        */
/* DATA LIB.campioneforces;
SET lib.campioneforces;
olduid = uid;
uid = matricola; RUN; */
proc sort data=lib.campioneforces;
by uid ; run;

/* primo passo*/ /* Le proc transpose*/

proc transpose data= lib.CDE_D out=CDE_D_MCOLS prefix=CDE_D_;
by uid tid block;
id CDE_D;
var cde_d;
run;

data lib.cde_d_mcols;
set cde_d_mcols;
array rr{*} cde_d_1-cde_d_12;
do i=1 to dim(rr);
if rr{i}^=. then rr{i}=1;
else rr{i}=0;
end;
run;


proc transpose data= lib.F3 out=F3_MCOLS prefix=F3_;
by uid tid block;
var f3;
id F3;
run;


data lib.f3_mcols;
set f3_mcols;
array rr{*} f3_1-f3_13;
do i=1 to dim(rr);
if rr{i}^=. then rr{i}=1;
else rr{i}=0;
end;
run;


proc transpose data= lib.FGH8 out=FGH8_MCOLS prefix=FGH8_;
by uid tid block;
var fgh8;
id FGH8;
run;



data lib.fgh8_mcols;
set fgh8_mcols;
array rr{*} fgh8_1-fgh8_10;
do i=1 to dim(rr);
if rr{i}^=. then rr{i}=1;
else rr{i}=0;
end;
run;


proc transpose data= lib.N1C out=N1C_MCOLS prefix=N1C_;
by uid tid block;
var n1c;
id N1C;
run;


data lib.n1c_mcols;
set n1c_mcols;
array rr{*} n1c_1-n1c_10;
do i=1 to dim(rr);
if rr{i}^=. then rr{i}=1;
else rr{i}=0;
end;
run;


proc transpose data= lib.N1K out=N1K_MCOLS prefix=N1K_;
by uid tid block;
var n1k;
id N1K;
run;



data lib.n1k_mcols;
set n1k_mcols;
array rr{*} n1k_1-n1k_9;
do i=1 to dim(rr);
if rr{i}^=. then rr{i}=1;
else rr{i}=0;
end;
run;


proc transpose data= lib.N3A out=N3A_MCOLS prefix=N3A_;
by uid tid block;
var n3a;
id N3A;
run;


data lib.n3a_mcols;
set n3a_mcols;
array rr{*} n3a_1-n3a_15;
do i=1 to dim(rr);
if rr{i}^=. then rr{i}=1;
else rr{i}=0;
end;
run;

/* fine le proc traspose*/
/*Secondo passo*/
/* 1) Ricodifica delle variabili della sezione I con 1 e 0 compreso gli esperimenti ( p.e.i1b diventa i1br)
2) Correzione dei dati mancanti o errati (p.e dalla L1altro oppure dalla sezione H
3)Se i1_old=1 or i1=2 and i1br=. then tutti 0
4)per gli uid che non appartengono agli esperimenti si segue una procedura trascinando sia 1 che 0
invece per gli esperimenti dal tempo t3 in poi (vale solo per forces1) viene trascianti solo 0*/
/*ricodifica delle varibili della sezione I e degli esperimenti*/

data dati_facolta;
/*set dati_facolta; */
if i1d in (1,2,3) then i1dr=1;  /* i1dr=1 iscritto altra laurea i1dr=0 non iscritto */
if i1d in (4) then i1dr=0;
if i1e in (3) then i1er=0;
if i1e in (1,2) then i1er=1;
if i1f in (3) then i1fr=0;
if i1f in (1,2) then i1fr=1;
if i1g in (3) then i1gr=0;
if i1g in (1,2) then i1gr=1;
if i1h in (3) then i1hr=0;
if i1h in (1,2) then i1hr=1;
if (i1d_alt3_t2 in (1,3) and i1dr=.) then i1dr=1;
if (i1d_alt3_t2 in (2,4) and i1dr=.) then i1dr=0;
if (i1e_alt3_t2 in (1,3) and i1er=.) then i1er=1;
if (i1e_alt3_t2 in (2,4) and i1er=.) then i1er=0;
if (i1f_alt3_t2 in (1,3) and i1fr=.) then i1fr=1;
if (i1f_alt3_t2 in (2,4) and i1fr=.) then i1fr=0;
if (i1g_alt3_t2 in (1,3) and i1gr=.) then i1gr=1;
if (i1g_alt3_t2 in (2,4) and i1gr=.) then i1gr=0;
if (i1h_alt3_t2 in (1,3) and i1hr=.) then i1hr=1;
if (i1h_alt3_t2 in (2,4) and i1hr=.) then i1hr=0;
run;




/*terzo passo*/
/* il merge delle librerie*/

data dati_facolta;
merge
/*Sezione B*/
/* lib.b0a lib.b0b lib.b7a lib.b7bbis */
lib.b8 lib.b8_before  
/*Sezione C CDE CDE1 CDE2 CDE3*/
lib.c2 
lib.cde lib.cde_a 
lib.cde_d_mcols lib.cde_dbis
lib.cde1 lib.cde1_c lib.cde1_d lib.cde1_e lib.cde1_ebis lib.cde1_f
lib.cde2_g 
/*Sezione F G H FGH*/
/* lib.f1a lib.f1b   lib.f1b_alt1_t2 lib.f1b_alt2_t2 lib.f1b_alt3_t2   lib.f3_mcols lib.f3bis 
lib.f4 */
lib.fgh6 /* lib.fgh8_mcols lib.fgh8bis 
lib.g3 lib.h4 */
/* Sezione I J */
lib.i1d lib.i1d_alt3_t2 lib.i1e lib.i1e_alt3_t2 lib.i1f lib.i1f_alt3_t2 
lib.i1g lib.i1g_alt3_t2 lib.i1h lib.i1h_alt3_t2 lib.j11
/*Sezione N*/
lib.n1a lib.n1b lib.n1b_old lib.n1c_mcols lib.n1bbis lib.n1d lib.n1d1 lib.n1f lib.n1f1 lib.n1g 
lib.n1h lib.n1h1 lib.n1j  lib.n1k_mcols lib.n1l lib.n1m 
lib.n1m lib.n2 lib.n2b lib.n2bbis lib.n2d  lib.n3 lib.n3a_mcols lib.n5 lib.n5_1 lib.n5_2 
lib.studio 
lib.t1 lib.t1a lib.t2 lib.t3 lib.t4 lib.t5 lib.t6 lib.t7
;
by uid tid;
drop block date ;
run;

proc sort data=dati_facolta;
by uid tid;
run;



/* shift del i1b*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1bx;
if (tid='T2' and i1b_alt3_t2^=.) then i1bx=i1b_alt3_t2;
if (tid='T3' and i1b=. and i1_old=2 and i1bx in (2,4)) then i1b=3;
if (tid='T3' and i1b=^.) then i1bx=i1b;
if (tid>'T3' and i1b=. and i1_old=2 and i1bx in (1,3)) then i1b=3;
if (tid>'T3' and i1b=. and i1_old=2 and i1bx in (2)) then i1b=2;
end;

else do;
retain i1bx ;
if (i1b^=.) then i1bx=i1b;
if (tid='T1' and i1b=.) then i1bx=.;
if (tid^='T1' and i1b=. and i1_old=2 and i1bx in (1,3)) then i1b=3;
if (tid^='T1' and i1b=. and i1_old=2 and i1bx in (2)) then i1b=2;

end;

run;

/*shift i1c*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1cx;
if (tid='T2' and i1c_alt3_t2^=.) then i1cx=i1c_alt3_t2;
if (tid='T3' and i1c=. and i1_old=2 and i1cx in (2,4)) then i1c=4;
if (tid='T3' and i1c=^.) then i1cx=i1c;
if (tid>'T3' and i1c=. and i1_old=2 and i1cx in (1,4)) then i1c=4;
if (tid>'T3' and i1c=. and i1_old=2 and i1cx in (2,3)) then i1c=3;
end;

else do;
retain i1cx ;
if (i1c^=.) then i1cx=i1c;
if (tid='T1' and i1c=.) then i1cx=.;
if (tid^='T1' and i1c=. and i1_old=2 and i1cx in (1,4)) then i1c=4;
if (tid^='T1' and i1c=. and i1_old=2 and i1cx in (2,3)) then i1c=3;

end;

run;



/*shift i1d*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1dx;
if (tid='T2' and i1d_alt3_t2^=.) then i1dx=i1d_alt3_t2;
if (tid='T3' and i1d=. and i1_old=2 and i1dx in (2,4)) then i1d=4;
if (tid='T3' and i1d=^.) then i1dx=i1d;
if (tid>'T3' and i1d=. and i1_old=2 and i1dx in (1,4)) then i1d=4;
if (tid>'T3' and i1d=. and i1_old=2 and i1dx in (2,3)) then i1d=3;
end;

else do;
retain i1dx ;
if (i1d^=.) then i1dx=i1d;
if (tid='T1' and i1d=.) then i1dx=.;
if (tid^='T1' and i1d=. and i1_old=2 and i1dx in (1,4)) then i1d=4;
if (tid^='T1' and i1d=. and i1_old=2 and i1dx in (2,3)) then i1d=3;

end;

run;



/*shift i1e*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1ex;
if (tid='T2' and i1e_alt3_t2^=.) then i1ex=i1e_alt3_t2;
if (tid='T3' and i1e=. and i1_old=2 and i1ex in (2,4)) then i1e=3;
if (tid='T3' and i1e=^.) then i1ex=i1e;
if (tid>'T3' and i1e=. and i1_old=2 and i1ex in (1,3)) then i1e=3;
if (tid>'T3' and i1e=. and i1_old=2 and i1ex in (2)) then i1e=2;
end;

else do;
retain i1ex ;
if (i1e^=.) then i1ex=i1e;
if (tid='T1' and i1e=.) then i1ex=.;
if (tid^='T1' and i1e=. and i1_old=2 and i1ex in (1,3)) then i1e=3;
if (tid^='T1' and i1e=. and i1_old=2 and i1ex in (2)) then i1e=2;


end;

run;



/*shift i1f*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1fx;
if (tid='T2' and i1f_alt3_t2^=.) then i1fx=i1f_alt3_t2;
if (tid='T3' and i1f=. and i1_old=2 and i1fx in (2,4)) then i1i=3;
if (tid='T3' and i1f=^.) then i1fx=i1f;
if (tid>'T3' and i1f=. and i1_old=2 and i1fx in (1,3)) then i1f=3;
if (tid>'T3' and i1f=. and i1_old=2 and i1fx in (2)) then i1f=2;
end;

else do;
retain i1fx ;
if (i1f^=.) then i1fx=i1f;
if (tid='T1' and i1f=.) then i1fx=.;
if (tid^='T1' and i1f=. and i1_old=2 and i1fx in (1,3)) then i1f=3;
if (tid^='T1' and i1f=. and i1_old=2 and i1fx in (2)) then i1f=2;

end;

run;


/*shift i1g*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1gx;
if (tid='T2' and i1g_alt3_t2^=.) then i1gx=i1g_alt3_t2;
if (tid='T3' and i1g=. and i1_old=2 and i1gx in (2,4)) then i1g=3;
if (tid='T3' and i1g=^.) then i1gx=i1g;
if (tid>'T3' and i1g=. and i1_old=2 and i1gx in (1,3)) then i1g=3;
if (tid>'T3' and i1g=. and i1_old=2 and i1gx in (2)) then i1g=2;
end;

else do;
retain i1gx ;
if (i1g^=.) then i1gx=i1g;
if (tid='T1' and i1g=.) then i1gx=.;
if (tid^='T1' and i1g=. and i1_old=2 and i1gx in (1,3)) then i1g=3;
if (tid^='T1' and i1g=. and i1_old=2 and i1gx in (2)) then i1g=2;

end;

run;



/*shift i1h*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1hx;
if (tid='T2' and i1h_alt3_t2^=.) then i1hx=i1h_alt3_t2;
if (tid='T3' and i1h=. and i1_old=2 and i1hx in (2,4)) then i1h=3;
if (tid='T3' and i1h=^.) then i1hx=i1h;
if (tid>'T3' and i1h=. and i1_old=2 and i1hx in (1,3)) then i1h=3;
if (tid>'T3' and i1h=. and i1_old=2 and i1hx in (2)) then i1h=2;
end;

else do;
retain i1hx ;
if (i1h^=.) then i1hx=i1h;
if (tid='T1' and i1h=.) then i1hx=.;
if (tid^='T1' and i1h=. and i1_old=2 and i1hx in (1,3)) then i1h=3;
if (tid^='T1' and i1h=. and i1_old=2 and i1hx in (2)) then i1h=2;

end;

run;



/*shift i1i*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1ix;
if (tid='T2' and i1i_alt3_t2^=.) then i1ix=i1i_alt3_t2;
if (tid='T3' and i1i=. and i1_old=2 and i1ix in (2,4)) then i1i=4;
if (tid='T3' and i1i=^.) then i1ix=i1i;
if (tid>'T3' and i1i=. and i1_old=2 and i1ix in (1,4)) then i1i=4;
if (tid>'T3' and i1i=. and i1_old=2 and i1ix in (2,3)) then i1i=3;
end;

else do;
retain i1ix ;
if (i1i^=.) then i1ix=i1i;
if (tid='T1' and i1i=.) then i1ix=.;
if (tid^='T1' and i1i=. and i1_old=2 and i1ix in (1,4)) then i1i=4;
if (tid^='T1' and i1i=. and i1_old=2 and i1ix in (2,3)) then i1i=3;

end;

run;



/*shift i1j*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1jx;
if (tid='T2' and i1j_alt3_t2^=.) then i1jx=i1j_alt3_t2;
if (tid='T3' and i1j=. and i1_old=2 and i1jx in (2,4)) then i1j=4;
if (tid='T3' and i1j=^.) then i1jx=i1j;
if (tid>'T3' and i1j=. and i1_old=2 and i1jx in (1,4)) then i1j=4;
if (tid>'T3' and i1j=. and i1_old=2 and i1jx in (2,3)) then i1j=3;
end;

else do;
retain i1jx ;
if (i1j^=.) then i1jx=i1j;
if (tid='T1' and i1j=.) then i1jx=.;
if (tid^='T1' and i1j=. and i1_old=2 and i1jx in (1,4)) then i1j=4;
if (tid^='T1' and i1j=. and i1_old=2 and i1jx in (2,3)) then i1j=3;

end;

run;


/*shift i1k*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1kx;
if (tid='T2' and i1k_alt3_t2^=.) then i1kx=i1k_alt3_t2;
if (tid='T3' and i1k=. and i1_old=2 and i1kx in (2,4)) then i1k=4;
if (tid='T3' and i1k=^.) then i1kx=i1k;
if (tid>'T3' and i1k=. and i1_old=2 and i1kx in (1,4)) then i1k=4;
if (tid>'T3' and i1k=. and i1_old=2 and i1kx in (2,3)) then i1k=3;
end;

else do;
retain i1kx ;
if (i1k^=.) then i1kx=i1k;
if (tid='T1' and i1k=.) then i1kx=.;
if (tid^='T1' and i1k=. and i1_old=2 and i1kx in (1,4)) then i1k=4;
if (tid^='T1' and i1k=. and i1_old=2 and i1kx in (2,3)) then i1k=3;

end;

run;


/*shift i1l*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1lx;
if (tid='T2' and i1l_alt3_t2^=.) then i1lx=i1l_alt3_t2;
if (tid='T3' and i1l=. and i1_old=2 and i1lx in (2,4)) then i1l=4;
if (tid='T3' and i1l=^.) then i1lx=i1l;
if (tid>'T3' and i1l=. and i1_old=2 and i1lx in (1,4)) then i1l=4;
if (tid>'T3' and i1l=. and i1_old=2 and i1lx in (2,3)) then i1l=3;
end;

else do;
retain i1lx ;
if (i1l^=.) then i1lx=i1l;
if (tid='T1' and i1l=.) then i1lx=.;
if (tid^='T1' and i1l=. and i1_old=2 and i1lx in (1,4)) then i1l=4;
if (tid^='T1' and i1l=. and i1_old=2 and i1lx in (2,3)) then i1l=3;

end;

run;




/*shift i1m*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1mx;
if (tid='T2' and i1m_alt3_t2^=.) then i1mx=i1m_alt3_t2;
if (tid='T3' and i1m=. and i1_old=2 and i1mx in (2,4)) then i1m=4;
if (tid='T3' and i1m=^.) then i1mx=i1m;
if (tid>'T3' and i1m=. and i1_old=2 and i1mx in (1,4)) then i1m=4;
if (tid>'T3' and i1m=. and i1_old=2 and i1mx in (2,3)) then i1m=3;
end;

else do;
retain i1mx ;
if (i1m^=.) then i1mx=i1m;
if (tid='T1' and i1m=.) then i1mx=.;
if (tid^='T1' and i1m=. and i1_old=2 and i1mx in (1,4)) then i1m=4;
if (tid^='T1' and i1m=. and i1_old=2 and i1mx in (2,3)) then i1m=3;

end;

run;



/*shift i1n*/
data dati_facolta;
set dati_facolta;
if (uid in ('394784','376934','348352','388433','394133','385926','396834','384761','416802','404867','359073','369677','424342',
'380316','339044','381335','404960','391439','354646','327645','394148','419389','338393','394862','410605','321785',
'356375','354849','355323','381420','322756','361790','370975','371685','368346','407304','366286','379520','376754',
'425344','426324','372506','380287','346693','357902','345490','411126','366688','427282','359729','425584','367851',
'265269','387136','376569','262525','394057','388286','405083','395958','400910','347143','355144','417363','372683',
'357489','396312','366452','367804','383744','428808','394564','423966','389353','279243','340160','345647','406159',
'425898','353210','371906','379030','390787','371268','426382','367357','425783','385067','395233','381751','415981',
'272884','376693','356736','398127','366342','385400','373610','381688','347009','327126','410563','372530','373958',
'408010','424951','410268','366116','359551','399757','419049','379244','360923','261773','303948','371989','379157',
'368871','384819','356845','395010','388007','396780','347506','411694','366883','296772','393813','358077','423801',
'395550','391603','320306','360841','357258','343474','386872','414217','351906','366201','393960','319779','382523',
'383559','356074','374199','428831','342880','381826','349333','383956','323113','380329','396044','368356','388788',
'384938','409170','348386','387531','401266','355105','356039','345080','414538','375081','381048','383954','389440',
'396540','368723','399609','367957','393585','404644','399088','386566','372828','411959','233022','324695','322561',
'303784','397380','394430','323633','409455','426827','384893','389260','425022','361688','409252','358208','369865',
'369606','370481','355383','380604','398677','322680','303758','273463','404743','370606','393555','390315','366063',
'352554','370280','385162','393817','375563','390356','375414'))
then do;
retain i1nx;
if (tid='T2' and i1n_alt3_t2^=.) then i1nx=i1n_alt3_t2;
if (tid='T3' and i1n=. and i1_old=2 and i1nx in (2,4)) then i1n=3;
if (tid='T3' and i1n=^.) then i1nx=i1n;
if (tid>'T3' and i1n=. and i1_old=2 and i1nx in (1,3)) then i1n=3;
if (tid>'T3' and i1n=. and i1_old=2 and i1nx in (2)) then i1n=2;
end;

else do;
retain i1nx ;
if (i1n^=.) then i1nx=i1n;
if (tid='T1' and i1n=.) then i1nx=.;
if (tid^='T1' and i1n=. and i1_old=2 and i1nx in (1,3)) then i1n=3;
if (tid^='T1' and i1n=. and i1_old=2 and i1nx in (2)) then i1n=2;

end;

run;






/*shift i1d*/
data dati_facolta;
set dati_facolta;
/* 1,2,3 = si  4 = no */
i1dr=4; if (i1d^=.) then i1dr=i1d; if (i1d_alt3_t2^=.) then i1dr=i1d_alt3_t2; 
i1er=4; if (i1e^=.) then i1er=i1e; if (i1e_alt3_t2^=.) then i1er=i1e_alt3_t2; 
i1fr=4; if (i1f^=.) then i1fr=i1d; if (i1f_alt3_t2^=.) then i1fr=i1f_alt3_t2; 
i1gr=4; if (i1g^=.) then i1gr=i1d; if (i1g_alt3_t2^=.) then i1gr=i1g_alt3_t2; 
i1hr=4; if (i1h^=.) then i1hr=i1d; if (i1h_alt3_t2^=.) then i1hr=i1h_alt3_t2; 

run;

/*shift del b8_before in quanto al forces1(T1 e T2) e forces2(T1) B8 aveva solo due opzioni. Nel b8_before
sono stati inseriti questi casi*/

data dati_facolta;
set dati_facolta;
if b8=. then b8=b8_before;
run;




/* shift del cde1_c*/
data dati_facolta;
set dati_facolta;
retain cde1_cx;
if (cde1_c^=. and b8=1) then cde1_cx=cde1_c;
if (tid ='T1' and cde1_c=. and b8=1) then cde1_cx=.;
if (tid^='T1' and  cde1 in (3) and cde1_c=. and b8=1) then cde1_c=cde1_cx;
run;

/* shift del cde1_d */
data dati_facolta;
set dati_facolta;
retain cde1_dx;
if (cde1_d^=. and b8=1) then cde1_dx=cde1_d;
if (tid ='T1' and cde1_d=. and b8=1) then cde1_dx=.;
if (tid^='T1' and  cde1 in (3) and cde1_d=. and b8=1) then cde1_d=cde1_dx;
run;

/* shift del cde1_e*/
data dati_facolta;
set dati_facolta;
retain cde1_ex;
if (cde1_e^=. and b8=1) then cde1_ex=cde1_e;
if (tid ='T1' and cde1_e=. and b8=1) then cde1_ex=.;
if (tid^='T1' and  cde1 in (3) and cde1_e=. and b8=1) then cde1_e=cde1_ex;
run;


/* Primo passo: a partire dalla variabile codifica si controllano le varibili 
della sezione I*/

data dati_facolta;
set dati_facolta;
if (codifica=1 and i1b^=2) then i1b=2;
if (codifica=2 and i1e^=2) then i1e=2;
if (codifica=3 and i1i^=3) then i1i=3;
if (codifica=4 and i1f^=2) then i1f=2;
if (codifica=5 and i1g^=2) then i1g=2;
if (codifica=6 and i1h^=2) then i1h=2;
if (codifica=7 and i1c^=3) then i1c=3;
if (codifica=8 and i1l^=3) then i1l=3;
if (codifica=9 and i1d^=3) then i1d=3;
if (codifica=10 and i1k^=3) then i1k=3;
if (codifica=11 and i1j^=3) then i1j=3;
if (codifica=12 and i1n^=2) then i1n=2;
if (codifica=100 and i1_old=1) then i1_old=2;

run;
/* se dice che non ha svolto l'attività di studio negli ultimi 6 mesi vengono compilate
le variabili della sezione I con la loro opzione (No)*/
data dati_facolta;
set dati_facolta;
if ((i1_old=1 or i1=2) and i1b=.) then i1b=3;
if ((i1_old=1 or i1=2) and i1c=.) then i1c=4;
if ((i1_old=1 or i1=2) and i1d=.) then i1d=4;
if ((i1_old=1 or i1=2) and i1e=.) then i1e=3;
if ((i1_old=1 or i1=2) and i1f=.) then i1f=3;
if ((i1_old=1 or i1=2) and i1g=.) then i1g=3;
if ((i1_old=1 or i1=2) and i1h=.) then i1h=3;
if ((i1_old=1 or i1=2) and i1i=.) then i1i=4;
if ((i1_old=1 or i1=2) and i1j=.) then i1j=4;
if ((i1_old=1 or i1=2) and i1k=.) then i1k=4;
if ((i1_old=1 or i1=2) and i1l=.) then i1l=4;
if ((i1_old=1 or i1=2) and i1m=.) then i1m=4;
if ((i1_old=1 or i1=2) and i1n=.) then i1n=3;
run;

data lib.dforces; /* merge finale con dati campione */
merge dati_facolta lib.campioneforces ;
by uid; run;

data lib.dforces;
set lib.dforces;
if uid="000000" then delete; /* toglie il test */
if tid="." then delete;      /* toglie dati non validi */
if tid="" then delete; /* 158 non sono missing, sono solo non risposte */
peso=1;
if fac='fac01' then peso=1.010695187;   /* agraria         */
if fac='fac02' then peso=1.743119266;   /* economia        */
if fac='fac03' then peso=1.43373494;    /* farmacia        */
if fac='fac04' then peso=1.651639344;   /* giurisprudenza  */
if fac='fac05' then peso=3.802005013;   /* ingegneria      */
if fac='fac06' then peso=2.130699088;   /* lettere         */
if fac='fac07' then peso=3.46728972;    /* medicina        */
if fac='fac08' then peso=1.30952381;    /* veterinaria     */
if fac='fac09' then peso=4.926829268;   /* psicologia      */
if fac='fac10' then peso=1.842975207;   /* formazione      */
if fac='fac11' then peso=1.623737374;   /* mmffnn          */
if fac='fac12' then peso=3.656565657;   /* scienze pol     */
if fac='fac13' then peso=1.572413793;   /* statistica      */
run;

